<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Indicações</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <style>
    :root { color-scheme: light dark; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center}
    main{max-width:1000px;margin:24px auto;padding:0 16px}
    h1{margin:0;font-size:1.25rem}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:20px}
    .card{padding:16px;border:1px solid rgba(0,0,0,.12);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,.08);text-align:left;font-size:.95rem}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.2);font:inherit}
    button{cursor:pointer}
    .muted{opacity:.7}
    .right{display:flex;gap:8px;align-items:center}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.2);font-size:.8rem}
    .ok{color:#16a34a}.err{color:#dc2626}
  </style>
</head>
<body>
  <header>
    <h1>Indicações</h1>
    <div class="right">
      <span id="status" class="pill muted">…</span>
      <button id="refresh">Recarregar</button>
    </div>
  </header>
  <main class="grid">
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Registros</strong>
        <div class="row" style="width:auto">
          <label class="muted">Página</label>
          <input id="cursor" type="number" min="0" value="0" style="width:100px" />
          <label class="muted">Limite</label>
          <input id="limit" type="number" min="1" max="200" value="50" style="width:90px" />
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Indicador</th><th>Data</th><th>Nome indicado</th>
            <th>Telefone</th><th>Recompensa</th><th>Faturamento</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="prev">Anterior</button>
        <button id="next">Próxima</button>
      </div>
      <div id="total" class="muted" style="margin-top:6px"></div>
    </section>

    <aside class="card">
      <strong>Novo cadastro</strong>
      <div class="row" style="margin-top:10px">
        <input id="indicador_id" placeholder="IND_0001 (obrigatório)"/>
        <input id="data_indicacao" type="date" />
        <input id="nome_indicado" placeholder="Nome do indicado" />
        <input id="telefone_indicado" placeholder="+5511999999999" />
        <select id="status_recompensa">
          <option value="Nao">Nao</option>
          <option value="EmProcessamento">EmProcessamento</option>
          <option value="Sim">Sim</option>
        </select>
        <input id="faturamento_gerado" type="number" step="1" min="0" value="0" />
        <label><input id="gerou_venda" type="checkbox" /> Gerou venda</label>
        <textarea id="observacoes" placeholder="Observações"></textarea>
        <button id="salvar">Salvar</button>
        <div id="msg" class="muted"></div>
      </div>
    </aside>
  </main>

  <script>
    const $ = (sel)=>document.querySelector(sel);
    const fmtBRL = (n)=> new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n/100);
    const S = (ok,msg)=>{ const s=$("#status"); s.className = "pill " + (ok?"ok":"err"); s.textContent = msg; };

    async function listar(){
      try{
        S(true,"carregando…");
        const limit = +$("#limit").value||50;
        const cursor = +$("#cursor").value||0;
        const r = await fetch(`/api/indicacoes?limit=${limit}&cursor=${cursor}`);
        if(!r.ok){ const e = await r.json().catch(()=>({})); throw new Error(e?.error?.message||r.statusText); }
        const {data=[], total=0, cursor:next=null} = await r.json();
        const tbody = $("#tbody"); tbody.innerHTML = "";
        for(const it of data){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${it.indicacao_id||""}</td>
            <td>${it.indicador_id||""}</td>
            <td>${it.data_indicacao||""}</td>
            <td>${it.nome_indicado||""}</td>
            <td>${it.telefone_indicado||""}</td>
            <td>${it.status_recompensa||""}</td>
            <td>${fmtBRL(+it.faturamento_gerado||0)}</td>`;
          tbody.appendChild(tr);
        }
        $("#total").textContent = `${total} registros`;
        $("#next").onclick = ()=>{ if(next!=null){ $("#cursor").value = next; listar(); } };
        $("#prev").onclick = ()=>{ const c = +$("#cursor").value||0; const l=+$("#limit").value||50; $("#cursor").value = Math.max(0, c - l); listar(); };
        S(true,"ok");
      }catch(e){ S(false, e.message||"falha ao listar"); }
    }

    async function salvar(){
      const body = {
        indicador_id: $("#indicador_id").value.trim(),
        data_indicacao: $("#data_indicacao").value,
        nome_indicado: $("#nome_indicado").value.trim(),
        telefone_indicado: $("#telefone_indicado").value.trim(),
        gerou_venda: $("#gerou_venda").checked,
        faturamento_gerado: +$("#faturamento_gerado").value||0,
        status_recompensa: $("#status_recompensa").value,
        observacoes: $("#observacoes").value.trim()
      };
      $("#msg").textContent = "salvando…";
      try{
        const r = await fetch("/api/indicacoes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
        const j = await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(j?.error?.message||"falha ao criar");
        $("#msg").textContent = "criado: " + (j?.data?.id||"");
        listar();
      }catch(e){ $("#msg").textContent = "erro: " + e.message; }
    }

    $("#refresh").onclick = listar;
    $("#salvar").onclick = salvar;
    window.addEventListener("load", listar);
  </script>
</body>
</html>

